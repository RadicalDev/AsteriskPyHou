#!/usr/bin/python

import sys
sys.path.append("../lib")

from database import Sqlite3Database
from ami import AMI
from functions import sms
from database import Sqlite3Database

DB = Sqlite3Database("../etc/users.db")

def game1():
    main_line = '8322611494'
    users = DB.dquery("users", fetchall=True)

    ami = AMI()
    for user in users:
        ami.create_call(user['phonenumber'], main_line, main_line, 'game-one', user['phonenumber'])

def game1_result(winner=False):
    for entry in DB.dquery("entry", where="game=1", fetchall=not winner, order_by="result ASC"):
        print entry



def game2():
    number = "8322611494"
    users = DB.dquery("users", fetchall=True)

    for user in users:
        code = open("/etc/secret_code", 'r').read().strip()
        msg = "Hurry! Call {0} and enter {1} when prompted".format(number, code)
        print user['phonenumber'], ": ", msg
        sms(user['phonenumber'], msg)

def game2_result(winner=False):
    for entry in DB.dquery("entry", where="game=2", fetchall=not winner, order_by="result ASC"):
        print entry

def game3():
    main_line = '2818097414'
    users = DB.dquery("users", fetchall=True)

    ami = AMI()
    for user in users:
        ami.create_call(user['phonenumber'], main_line,
                        main_line, 'game-three', user['phonenumber'])

def game3_result(winner=False):
    for entry in DB.dquery("entry", where="game=1", fetchall=not winner, order_by="result ASC"):
        print entry

games = {'1':(game1, game1_result),
         '2':(game2, game2_result),
         '3':(game3, game3_result)
}

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print "launch_game <game_number>"
        sys.exit(1)

    get_result = False
    get_winner = False

    game_number = sys.argv[1]
    if len(sys.argv) > 2:
        if sys.argv[2] == 'results':
            get_result = True
        elif sys.argv[2] == 'winner':
            get_winner = True

    if game_number in games:
        if not get_result and not get_winner:
            games[game_number][0]()
            print "Started game number ", game_number
        elif get_result:
            games[game_number][1]()
        elif get_winner:
            games[game_number][1](winner=True)


